#!/bin/bash
set -e

ZLIB_VERSION="1.3"
ZLIB_ARCHIVE="zlib-$ZLIB_VERSION.tar.gz"
ZLIB_URL="https://zlib.net/fossils/$ZLIB_ARCHIVE"
ZLIB_DIR="zlib-$ZLIB_VERSION"

export CC=clang

# Number of parallel jobs (default to all CPU cores)
JOBS=${1:-$(sysctl -n hw.ncpu)}

echo "🔧 Using $JOBS parallel jobs"

# Create temporary directory and change to it
TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT
cd "$TMPDIR"

echo "📁 Working in temporary directory: $TMPDIR"

echo "📦 Downloading zlib $ZLIB_VERSION..."
curl -LO "$ZLIB_URL"

echo "🚀 Running build benchmark with hyperfine..."
hyperfine \
  --prepare "
    rm -rf $ZLIB_DIR && \
    tar xf $ZLIB_ARCHIVE && \
    cd $ZLIB_DIR && \
    sed -i '' '/# *define fdopen.*NULL/d' zutil.h && \
    ./configure
  " \
  "cd $ZLIB_DIR && make -j$JOBS > /dev/null"

echo "✅ Benchmark complete."
